<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<title>EtherCAT Slave: File access over EtherCAT</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
     <tr style="height: 40px;">
         <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg" /></a></td>
         <td id="projectalign"><div id="projectname"> EtherCAT Slave<span id="projectnumber"></span></div></td>
         <td id="projectbrief" align="right"><img src=EtherCATLogoIcon.png /></a></td>
         <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
     </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('_fo_e_page.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">File access over EtherCAT</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Description</h2>
<p>File access over EtherCAT (FoE) is a straightforward protocol that shares similarities with TFTP (Trivial File Transfer Protocol) but it does not require a full TCP/IP stack. <br  />
 This page briefly describes the APIs related to FoE and testing FoE with TwinCAT.</p>
<h2>FoE API Details</h2>
<p>The motivation of the code snippets is to provide a better understanding of how to handle the FoE file data. For a detailed overview please refer to the example code.</p>
<p>The API <b>EC_SLV_APP_FoE_fileWrite</b> shall be called during the file download/write which shall then call the API <b>NVM_APP_writeAsync</b> to write the file data into the flash. When the file data write is complete it shall trigger the call to the registered callback function. The API <b>EC_SLV_APP_FoE_fileOpen</b> is called prior to the API <b>EC_SLV_APP_FoE_fileWrite</b>, where the file access password is received and stored in a file header along with the file data.</p>
<p>If the file data size is less than the FoE mailbox frame size, 1012 bytes then the API <b>EC_SLV_APP_FoE_fileWrite</b> is called once with the complete file data . If the file data size is larger, then the API <b>EC_SLV_APP_FoE_fileWrite</b> is called multiple times with the file data segments of maximum size of 1012 bytes.</p>
<div class="fragment"><div class="line">uint32_t EC_SLV_APP_FoE_fileWrite(<span class="keywordtype">void</span> *pContext, uint16_t* pData, uint16_t size)</div>
<div class="line">{</div>
<div class="line">    uint32_t    retVal;</div>
<div class="line"> </div>
<div class="line">    retVal = ECAT_FOE_ERRCODE_DISKFULL;</div>
<div class="line"> </div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Handle memory allocations </span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Concatenate the file data size and file access password as a file header</span></div>
<div class="line"> </div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Trigger async write to flash</span></div>
<div class="line">    error = NVM_APP_writeAsync( NVM_TYPE_FLASH,</div>
<div class="line">                                CONFIG_FLASH0,</div>
<div class="line">                                APP_OSPI_FLASH_OFFSET_BASE,</div>
<div class="line">                                (uint32_t)(<span class="keyword">sizeof</span>(ESL_FOE_header_t) + foeFileWriteChunkSize),</div>
<div class="line">                                (uint8_t*)foeBufferPtr);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (error != NVM_ERR_SUCCESS)</div>
<div class="line">    {</div>
<div class="line">        retVal = ECAT_FOE_ERRCODE_ACCESS;</div>
<div class="line">        <span class="keywordflow">return</span> retVal;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    retVal = size;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> retVal;</div>
<div class="line">}</div>
</div><!-- fragment --><p>The callback function is registered in the API <b>EC_SLV_APP_FoE_fileOpen</b>.</p>
<div class="fragment"><div class="line">uint32_t EC_SLV_APP_FoE_fileOpen(<span class="keywordtype">void</span>* pContext, <span class="keyword">const</span> <span class="keywordtype">char</span>* pName, uint16_t nameLen, <span class="keywordtype">bool</span> isRead, uint32_t password)</div>
<div class="line">{</div>
<div class="line">    uint32_t    retVal;</div>
<div class="line">    retVal = <a class="code hl_enumvalue" href="group___e_c___a_p_i___s_l_v___e_r_r_o_r___c_o_d_e_s_ga022716c308f5d5bd84876c11d568a77e.html#gga022716c308f5d5bd84876c11d568a77eaf748c4e7857631705f4832b53534282a">EC_API_eERR_NONE</a>;</div>
<div class="line"><span class="preprocessor">#if !(defined FBTLPROVIDER) || (FBTLPROVIDER==0)</span></div>
<div class="line">    NVM_err_t error;</div>
<div class="line">    error = NVM_APP_registerCallback(EC_SLV_APP_FoE_fileWriteCb);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (error != NVM_ERR_SUCCESS)</div>
<div class="line">    {</div>
<div class="line">        retVal = ECAT_FOE_ERRCODE_NOTDEFINED;</div>
<div class="line">        <span class="keywordflow">return</span> retVal;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    fileAccessPassword = password;</div>
<div class="line">    <span class="keywordflow">return</span> retVal;</div>
<div class="line">}</div>
<div class="ttc" id="agroup___e_c___a_p_i___s_l_v___e_r_r_o_r___c_o_d_e_s_ga022716c308f5d5bd84876c11d568a77e_html_gga022716c308f5d5bd84876c11d568a77eaf748c4e7857631705f4832b53534282a"><div class="ttname"><a href="group___e_c___a_p_i___s_l_v___e_r_r_o_r___c_o_d_e_s_ga022716c308f5d5bd84876c11d568a77e.html#gga022716c308f5d5bd84876c11d568a77eaf748c4e7857631705f4832b53534282a">EC_API_eERR_NONE</a></div><div class="ttdeci">@ EC_API_eERR_NONE</div><div class="ttdef"><b>Definition</b> ecSlvApiDef_error.h:45</div></div>
</div><!-- fragment --><p> This callback shall handle the async NVM write status and freeing up the allocated memory during the file data write to flash.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> EC_SLV_APP_FoE_fileWriteCb(uint32_t status)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (status == NVM_ERR_SUCCESS)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Handle the error</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    ...</div>
<div class="line">    <span class="comment">// Free the allocated buffers</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>(foeBufferPtr != NULL)</div>
<div class="line">    {</div>
<div class="line">        OSAL_MEMORY_free(foeBufferPtr);</div>
<div class="line">        foeBufferPtr = NULL;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p> The API <b>EC_SLV_APP_FoE_fileRead</b> shall be called during the file upload/read which shall then call the API <b>NVM_APP_read</b> to read the file data from the flash. It also checks for the password authentication for the file access.</p>
<p>If the stored file data size is less than the FoE mailbox frame size, 1012 bytes then the API <b>EC_SLV_APP_FoE_fileRead</b> is called once to retrieve the complete file data. If the stored file data size is larger, then the API <b>EC_SLV_APP_FoE_fileRead</b> is called multiple times to retrieve the file data in segments of maximum size of 1012 bytes.</p>
<div class="fragment"><div class="line">uint32_t EC_SLV_APP_FoE_fileRead(<span class="keywordtype">void</span>* pContext, uint16_t* pData, uint16_t size, uint32_t fileOffset)</div>
<div class="line">{</div>
<div class="line">    uint32_t            retVal;</div>
<div class="line">    <span class="keyword">static</span> uint32_t     foeFileReadDoneSize = 0;</div>
<div class="line">    uint32_t            foeFileChunkReadSize = 0;</div>
<div class="line">    ESL_FOE_header_t    foeHeader = {0};</div>
<div class="line"> </div>
<div class="line">    retVal = ECAT_FOE_ERRCODE_ILLEGAL;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Read the file data size and password info</span></div>
<div class="line"> </div>
<div class="line">    NVM_err_t error;</div>
<div class="line">    error = NVM_APP_read(NVM_TYPE_FLASH,</div>
<div class="line">                         CONFIG_FLASH0,</div>
<div class="line">                         APP_OSPI_FLASH_OFFSET_BASE,</div>
<div class="line">                         (uint32_t)<span class="keyword">sizeof</span>(ESL_FOE_header_t),</div>
<div class="line">                         (uint8_t*)&amp;foeHeader);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (error != NVM_ERR_SUCCESS)</div>
<div class="line">    {</div>
<div class="line">        retVal = ECAT_FOE_ERRCODE_FLASH_ERROR;</div>
<div class="line">        <span class="keywordflow">return</span> retVal;</div>
<div class="line">    }                     </div>
<div class="line"> </div>
<div class="line">    <span class="comment">// File access password validation</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (foeHeader.password != fileAccessPassword)</div>
<div class="line">    {</div>
<div class="line"><span class="preprocessor">        #if (defined DEBUGTRACING) &amp;&amp; (DEBUGTRACING == 1)</span></div>
<div class="line">            OSAL_printf(<span class="stringliteral">&quot;FoE - File access password incorrect!\n\r&quot;</span>);</div>
<div class="line"><span class="preprocessor">        #endif</span></div>
<div class="line">        retVal = ECAT_FOE_ERRCODE_ACCESS;</div>
<div class="line">        <span class="keywordflow">return</span> retVal;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Send the file data</span></div>
<div class="line"> </div>
<div class="line">    error = NVM_APP_read(NVM_TYPE_FLASH,</div>
<div class="line">                         CONFIG_FLASH0,</div>
<div class="line">                         APP_OSPI_FLASH_OFFSET_BASE + <span class="keyword">sizeof</span>(ESL_FOE_header_t) + fileOffset,</div>
<div class="line">                         (uint32_t)foeFileChunkReadSize,</div>
<div class="line">                         (uint8_t*)pData);</div>
<div class="line"> </div>
<div class="line">    </div>
<div class="line">    ...  </div>
<div class="line"> </div>
<div class="line">    retVal = foeFileChunkReadSize;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> retVal;</div>
<div class="line">}</div>
</div><!-- fragment --><h2>FoE testing in TwinCAT</h2>
<h3>File Download</h3>
<p>A sample text file <b>FoE_Test_File.txt</b> having 510 bytes shall be used to download into the flash memory of the EtherCAT slave device from TwinCAT. This file access shall be password protected and the password shall be <b>0x1234ABFE</b> for example. In case, the file access is required without the password protection then leave the password to its default state <b>0x00000000</b>.</p>
<p>Follow the below steps to download a sample file to EtherCAT device from TwinCAT.</p>
<ol>
<li>
Scan for the EtherCAT device in TwinCAT and click on the <b>Box 1 (TI EtherCAT Toolkit for AMXXX.R5F).</b>  </li>
<li>
Click on the <b>Online</b> tab. </li>
<li>
Click on the <b>Pre-Op</b> button under the State Machine block.  </li>
<li>
Wait until the current state changes to <b>PREOP</b>.  </li>
<li>
Click on the <b>Download...</b> button under File Access over EtherCAT block.  </li>
<li>
Wait for the popup window to appear titled as <b>Open</b>.  </li>
<li>
Select the file extension as <b>All Files(*.*)</b> in the drop down.  </li>
<li>
Select the file to be downloaded to the EtherCAT slave device.  </li>
<li>
Click on the <b>Open</b> button.  </li>
<li>
Wait for the popup window to appear titled as <b>Edit FoE Name</b>.  </li>
<li>
Provide a password for the file in hex.  </li>
<li>
Click on the <b>OK</b> button.  </li>
</ol>
<div class="image">
<img src="FoE_file_download_TwinCAT_1.png" alt=""/>
<div class="caption">
FoE File Download TwinCAT 1</div></div>
    <div class="image">
<img src="FoE_file_download_TwinCAT_2.png" alt=""/>
<div class="caption">
FoE File Download TwinCAT 2</div></div>
    <h3>File Upload</h3>
<p>A text file <b>FoE_Test_File.txt</b> which has been downloaded successfully in the previous step, can be uploaded back to TwinCAT from the EtherCAT device.</p>
<p>Follow the below steps to upload a sample file from EtherCAT device into TwinCAT.</p>
<ol>
<li>
Scan for the EtherCAT device in TwinCAT and click on the <b>Box 1 (TI EtherCAT Toolkit for AMXXX.R5F).</b>  </li>
<li>
Click on the <b>Online</b> tab.  </li>
<li>
Click on the <b>Pre-Op</b> button under the State Machine block.  </li>
<li>
Wait until the current state changes to <b>PREOP</b>.  </li>
<li>
Click on the <b>Upload...</b> button under File Access over EtherCAT block.  </li>
<li>
Wait for the popup window to appear titled as <b>Save As</b>.  </li>
<li>
Select the file extension as <b>All Files(*.*)</b> in the drop down for 'Save as type'.  </li>
<li>
Enter the name of the file with extension to save the file from the EtherCAT slave device.  </li>
<li>
Click on the <b>Save</b> button.  </li>
<li>
Wait for the popup window to appear titled as <b>Edit FoE Name</b>.  </li>
<li>
Provide a password for the file access in hex (must be same password used during the download).  </li>
<li>
Click on the <b>OK</b> button.  </li>
</ol>
<div class="image">
<img src="FoE_file_upload_TwinCAT_1.png" alt=""/>
<div class="caption">
FoE File Upload TwinCAT 1</div></div>
    <div class="image">
<img src="FoE_file_upload_TwinCAT_2.png" alt=""/>
<div class="caption">
FoE File Upload TwinCAT 2</div></div>
     </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
