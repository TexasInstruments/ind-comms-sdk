<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<title>EtherCAT Slave: Ethernet over EtherCAT</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
     <tr style="height: 40px;">
         <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg" /></a></td>
         <td id="projectalign"><div id="projectname"> EtherCAT Slave<span id="projectnumber"></span></div></td>
         <td id="projectbrief" align="right"><img src=EtherCATLogoIcon.png /></a></td>
         <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
     </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('_eo_e_page.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Ethernet over EtherCAT</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Description</h2>
<p>Ethernet over EtherCAT (EoE) transparently tunnels standard Ethernet communication via EtherCAT. Tunneling allows the master device to optimize Ethernet communication without affecting the process data communication. EoE enables communication with network devices. EoE is typically used for devices with TCP/IP stack, such as a web server, or for infrastructure devices such as switch ports, to which peripheral devices can be connected.</p>
<h2>EoE API</h2>
<p>The motivation of the code snippets is to provide a better understanding of how to configure and transport the Ethernet frames. For a detailed overview please refer to the example code.</p>
<h3>Network settings</h3>
<p>Register a function for network settings. The function is called when the EtherCAT master sends an EoE frame with the network device settings (IP address, Gateway, MAC address and DNS server). These parameters must be given then to the users virtual network interface.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> EC_SLV_APP_EoE_SS_settingIndHandler(</div>
<div class="line">   <span class="keywordtype">void</span> *pContext,</div>
<div class="line">   uint16_t *pMac,</div>
<div class="line">   uint16_t *pIp,</div>
<div class="line">   uint16_t *pSubNet,</div>
<div class="line">   uint16_t *pDefaultGateway,</div>
<div class="line">   uint16_t *pDnsIp)</div>
<div class="line">{</div>
<div class="line">   uint32_t retVal = 0;</div>
<div class="line">   uint32_t ipAddr = OSAL_VNET_ntohl(((uint32_t*)pIp)[0]);</div>
<div class="line">   uint32_t subNet = OSAL_VNET_ntohl(((uint32_t*)pSubNet)[0]);</div>
<div class="line">   uint32_t defGW = OSAL_VNET_ntohl(((uint32_t*)pDefaultGateway)[0]);</div>
<div class="line"> </div>
<div class="line">   OSAL_VNET_configureMAC(vnetInterface, (uint8_t*)pMac);</div>
<div class="line">   OSAL_VNET_configureIPv4(vnetInterface, ipAddr, subNet);</div>
<div class="line">   OSAL_VNET_setLinkState(vnetInterface, OSAL_LINK_Up);</div>
<div class="line">   OSAL_VNET_configureIPv4Route(vnetInterface, defGW);</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">EC_API_SLV_EoE_cbRegisterSettingIndHandler(handle, EC_SLV_APP_EoE_SS_settingIndHandler, pAppInstance);</div>
</div><!-- fragment --><h3>Receiving a frame</h3>
<p>This function registers a function which must be implemented by the user. The user defined function is called any time an EoE frame is received. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> EC_SLV_APP_EoE_SS_receiveHandler(<span class="keywordtype">void</span> *pContext, uint16_t *pData, uint16_t size)</div>
<div class="line">{</div>
<div class="line">   <span class="keywordtype">bool</span> frameHandled = <span class="keyword">false</span>;</div>
<div class="line">   uint32_t ret = 0;</div>
<div class="line"> </div>
<div class="line">   ret = OSAL_VNET_writeFrame(vnetInterface, size, pData);</div>
<div class="line">   <span class="keywordflow">if</span>(ret == OSAL_ERR_NoError)</div>
<div class="line">   {</div>
<div class="line">       frameHandled = <span class="keyword">true</span>;</div>
<div class="line">   }</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">return</span> frameHandled;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">EC_API_SLV_EoE_cbRegisterReceiveHandler(handle, EC_SLV_APP_EoE_SS_receiveHandler, pAppInstance);</div>
</div><!-- fragment --><h3>Sending a frame</h3>
<p>Use this function to send Ethernet frames over the EtherCAT network.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> EC_SLV_APP_EoE_send()</div>
<div class="line">{</div>
<div class="line">   <span class="keyword">static</span> uint8_t aFrameBuf[1580] = {0}; <span class="comment">/* MTU=1540 with headers, so use a bit more */</span></div>
<div class="line">   uint32_t rxLength = 0;</div>
<div class="line"> </div>
<div class="line">   OSAL_VNET_readFrame(vnetInterface, <span class="keyword">sizeof</span>(aFrameBuf), aFrameBuf, &amp;rxLength);</div>
<div class="line">   <span class="keywordflow">if</span>(rxLength != 0)</div>
<div class="line">   {</div>
<div class="line">       EC_API_SLV_EoE_sendFrame(handle, rxLength, aFrameBuf);</div>
<div class="line">   }</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Network interface settings</h2>
<p>Set an IP address to the EtherCAT network interface.</p>
<div class="image">
<img src="nic.png" alt="" width="20%"/>
<div class="caption">
IP configuration</div></div>
<h2>TwinCAT settings</h2>
<h3>Master settings</h3>
<p>Enable Virtual Ethernet Switch and the TCP/IP Stack connection for the EtherCAT Master on TwinCAT.</p>
<div class="image">
<img src="master_settings.png" alt="" width="25%"/>
<div class="caption">
Master configuration</div></div>
<h3>Slave settings</h3>
<p>Enable Virtual Ethernet Port and set an IP address to the EtherCAT slave. The default gateway must the EtherCAT network interface IP address.</p>
<div class="image">
<img src="slave_settings.png" alt="" width="25%"/>
<div class="caption">
Slave configuration</div></div>
<h2>Testing</h2>
<p>The EtherCAT slave simple demo implements EoE protocol for AM64x EVM with the Linux SDK. The application creates a Linux TAP device (a virtual network interface) and the IP configuration are set by the EtherCAT master.</p>
<p>Restart the communication on TwinCAT with the EoE settings. If the application and the IP configuration are correct, once the slave is brought to PreOP state, then the virtual network interface should be available.</p>
<div class="image">
<img src="linux_tap_device.png" alt="" width="40%"/>
<div class="caption">
EoE Network interface in Linux</div></div>
<p>Therefore, now it should be possible to ping the device or to open an SSH communication.</p>
<div class="image">
<img src="ssh_eoe.png" alt="" width="40%"/>
<div class="caption">
SSH connection to AM64x from Windows</div></div>
<p>For troubleshooting is highly recommended to use Wireshark. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
