<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<title>EtherCAT Slave: Non-Volatile Memory (NVM)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
     <tr style="height: 40px;">
         <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg" /></a></td>
         <td id="projectalign"><div id="projectname"> EtherCAT Slave<span id="projectnumber"></span></div></td>
         <td id="projectbrief" align="right"><img src=EtherCATLogoIcon.png /></a></td>
         <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
     </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('persistentstorage.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Non-Volatile Memory (NVM)</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="sectionNVM1"></a>
Introduction</h1>
<p>This page shall focus on the customer implementation of NVM (Non Volatile Memory) interface. The demo implementation is specifically designed for the TI reference design. However, itâ€™s important to note that customization is required for the customer to adapt it to their specific needs. In other words, the customer must either create their own implementation or tailor the existing demo implementation to suit their requirements.</p>
<div class="image">
<img src="nvmLayeredArchitecture.png" alt=""/>
<div class="caption">
NVM Layer Architecture</div></div>
    <h1><a class="anchor" id="sectionNVM2"></a>
Implementation Details</h1>
<p>The application shall make use of the public functions related to the non-volatile memory interface from the header file nvm.h.</p>
<p>The application shall be able to specify the type of non-volatile memory used to store/retrieve the data, which is provided as an enumeration.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> NVM_type {</div>
<div class="line">    NVM_TYPE_EEPROM = 0,</div>
<div class="line">    NVM_TYPE_FLASH,</div>
<div class="line">    NVM_TYPE_END_NUM</div>
<div class="line">} NVM_type_t;</div>
</div><!-- fragment --><p>The application can write data to the non-volatile memory in two modes.</p>
<ol>
<li>
Blocking mode <ul>
<li>
The blocking API <b> NVM_APP_write </b> shall be used which directly triggers the TI drivers to write data into the non-volatile memory. </li>
</ul>
</li>
<li>
Non blocking mode <ul>
<li>
The non blocking API <b> NVM_APP_writeAsync </b> shall be used which triggers the thread to write data into the non-volatile memory. </li>
</ul>
</li>
</ol>
<p>In the non blocking mode before calling the API <b> NVM_APP_writeAsync </b> it is necessary to call the APIs <b> NVM_APP_init </b> which shall start the write task <b>NVM_APP_writeTask</b> with the specified priority and a semaphore for it,</p>
<div class="fragment"><div class="line">uint32_t NVM_APP_init(<span class="keyword">const</span> OSAL_TASK_Priority_t priority);</div>
</div><!-- fragment --><p>and <b> NVM_APP_registerCallback </b> to register the callback function to get the status of the async write process.</p>
<div class="fragment"><div class="line">uint32_t NVM_APP_registerCallback(NVM_APP_writeCallback_t callback)</div>
</div><!-- fragment --><p>The callback function type shall be as specified below. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> void(*NVM_APP_writeCallback_t)(uint32_t status);</div>
</div><!-- fragment --><p>The write task <b>NVM_APP_writeTask</b> created for the non blocking NVM data write shall trigger the registered callback with the write status as a argument provided in the form of an enumeration specified below.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> NVM_err {</div>
<div class="line">    NVM_ERR_SUCCESS = 0,</div>
<div class="line">    NVM_ERR_FAIL,</div>
<div class="line">    NVM_ERR_BUSY,</div>
<div class="line">    NVM_ERR_REJECT,</div>
<div class="line">    NVM_ERR_INVALID,</div>
<div class="line">    NVM_ERR_END_ENUM</div>
<div class="line">} NVM_err_t;</div>
</div><!-- fragment --><p>As a contradictory, the API <b> NVM_APP_close </b> kills the write task <b>NVM_APP_writeTask</b> and the semaphore which were being created by the API <b> NVM_APP_init </b> </p><div class="fragment"><div class="line">uint32_t NVM_APP_close(<span class="keywordtype">void</span>);</div>
</div><!-- fragment --><p>The APIs <b>NVM_APP_write</b> and <b>NVM_APP_writeAsync</b> shall have same set of parameters.</p>
<div class="fragment"><div class="line">uint32_t NVM_APP_write(</div>
<div class="line">    <span class="keyword">const</span> NVM_type_t type,</div>
<div class="line">    <span class="keyword">const</span> uint32_t <span class="keywordtype">id</span>,</div>
<div class="line">    <span class="keyword">const</span> uint32_t offset,</div>
<div class="line">    <span class="keyword">const</span> uint32_t length,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span> * <span class="keyword">const</span> pData);</div>
<div class="line"> </div>
<div class="line">uint32_t NVM_APP_writeAsync(</div>
<div class="line">    <span class="keyword">const</span> NVM_type_t type,</div>
<div class="line">    <span class="keyword">const</span> uint32_t <span class="keywordtype">id</span>,</div>
<div class="line">    <span class="keyword">const</span> uint32_t offset,</div>
<div class="line">    <span class="keyword">const</span> uint32_t length,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span> * <span class="keyword">const</span> pData);</div>
</div><!-- fragment --><p>The parameter <b>type</b> can be <em><b>NVM_TYPE_EEPROM</b></em> or <em><b>NVM_TYPE_FLASH</b></em> depending on the implementation. <br  />
 The parameter <b>id</b> can be <em><b>CONFIG_EEPROM0</b></em> or <em><b>CONFIG_FLASH0</b></em> or similar depending on the sysconfig adaptations.</p>
<div class="image">
<img src="sysconfig_eeprom.png" alt=""/>
<div class="caption">
SysConfig - EEPROM</div></div>
    <div class="image">
<img src="sysconfig_flash.png" alt=""/>
<div class="caption">
SysConfig - Flash</div></div>
    <p>The parameter <b>offset</b> shall be the data offset to write the data block into the non-volatile memory. For example, as per the AM64x/AM243x EVM User's Guide, the first 259 bytes of addressable EEPROM memory are pre-programmed with board identification information. In this case the <em>offset</em> shall be at least <b>259</b>.</p>
<div class="image">
<img src="EEPROM_brdID_Info.png" alt=""/>
<div class="caption">
AM64x/AM243x EVM User's Guide</div></div>
    <p>The parameter <b>length</b> shall the length of the data block and <b>pData</b> shall be the pointer to the data block to be written into the non-volatile memory. <br  />
 <b>Note:The API <b>NVM_APP_writeAsync</b> does NOT copy the data to another buffer, therefore please ensure that the buffer is not destroyed after calling this API.</b></p>
<p>Below is the sample implementation of the API <b>NVM_APP_write</b> in a application.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define EEPROM_DATA_OFFSET  (0x200U)</span></div>
<div class="line"> </div>
<div class="line">uint32_t buffer_length = 0x10; </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Allocate a memory block for the buffer used to store the data to be written into NVM.</span></div>
<div class="line">buffer = OSAL_MEMORY_calloc(buffer_length,<span class="keyword">sizeof</span>(uint8_t));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Fill the allocated memory with valid data to be written into NVM.</span></div>
<div class="line"> </div>
<div class="line">NVM_APP_write(NVM_TYPE_EEPROM,</div>
<div class="line">            CONFIG_EEPROM0,</div>
<div class="line">            EEPROM_DATA_OFFSET,</div>
<div class="line">            buffer_length,</div>
<div class="line">            buffer);</div>
</div><!-- fragment --><p>Below is the sample implementation of the API <b>NVM_APP_read</b> in a application.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define EEPROM_DATA_OFFSET  (0x200U)</span></div>
<div class="line"> </div>
<div class="line">uint32_t buffer_length = 0x10; </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Allocate a memory block for the buffer used to store the data read from the NVM.</span></div>
<div class="line">buffer = OSAL_MEMORY_calloc(buffer_length,<span class="keyword">sizeof</span>(uint8_t));</div>
<div class="line"> </div>
<div class="line">NVM_APP_read(NVM_TYPE_EEPROM,</div>
<div class="line">            CONFIG_EEPROM0,</div>
<div class="line">            EEPROM_DATA_OFFSET,</div>
<div class="line">            buffer_length,</div>
<div class="line">            buffer);</div>
</div><!-- fragment --><p>Below is the sample implementation of the API <b>NVM_APP_writeAsync</b> in a application.</p>
<div class="fragment"><div class="line"><span class="comment">// Callback function to be attached to get the status of async NVM write.</span></div>
<div class="line"><span class="comment">// Hint: Use the registered callback to free the data buffer.</span></div>
<div class="line"><span class="keywordtype">void</span> myWriteAsyncCallback(uint32_t status)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (status != NVM_ERR_SUCCESS)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// handle the error status</span></div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// free any allocated buffers etc..</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define EEPROM_DATA_OFFSET  (0x200U)</span></div>
<div class="line"> </div>
<div class="line">uint32_t buffer_length = 0x10;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Allocate a memory block for the buffer used to store the data to be written into NVM.</span></div>
<div class="line">buffer = OSAL_MEMORY_calloc(buffer_length,<span class="keyword">sizeof</span>(uint8_t));</div>
<div class="line"> </div>
<div class="line">NVM_err_t error;</div>
<div class="line"> </div>
<div class="line">error = NVM_APP_init(OSAL_TASK_Prio_Normal);</div>
<div class="line"><span class="keywordflow">if</span> (error != NVM_ERR_SUCCESS)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// handle the errors</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">error = NVM_APP_registerCallback(myWriteAsyncCallback);</div>
<div class="line"><span class="keywordflow">if</span> (error != NVM_ERR_SUCCESS)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// handle the errors</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Fill the allocated memory with valid data to be written into NVM.</span></div>
<div class="line"> </div>
<div class="line">error = NVM_APP_writeAsync(NVM_TYPE_EEPROM,</div>
<div class="line">            CONFIG_EEPROM0,</div>
<div class="line">            EEPROM_DATA_OFFSET,</div>
<div class="line">            buffer_length,</div>
<div class="line">            buffer);</div>
<div class="line"><span class="keywordflow">if</span> (error != NVM_ERR_SUCCESS)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// handle the busy or error state</span></div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.9.7 </li>
  </ul>
</div>
</body>
</html>
