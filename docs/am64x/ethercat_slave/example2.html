<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<title>EtherCAT Slave: CiA 402 Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
     <tr style="height: 40px;">
         <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg" /></a></td>
         <td id="projectalign"><div id="projectname"> EtherCAT Slave<span id="projectnumber"></span></div></td>
         <td id="projectbrief" align="right"><img src=EtherCATLogoIcon.png /></a></td>
         <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
     </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('example2.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">CiA 402 Example</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="section4221"></a>
Scope</h1>
<p>This example covers how to load an ESI File to the SDK and how to enable the CiA 402 device profile.</p>
<h1><a class="anchor" id="section4222"></a>
Related Files</h1>
<p><a href="ec_slv_ci_a402_8c-example.html" class="ec_slv_ci_a402_8c-example.html">ecSlvCiA402.c</a><br  />
 <a href="ec_slv_ci_a402_8h-example.html" class="ec_slv_ci_a402_8h-example.html">ecSlvCiA402.h</a><br  />
 <a href="_e_s_l_cia402_demo_8c-example.html" class="_e_s_l_cia402_demo_8c-example.html">ESL_cia402Demo.c</a><br  />
 <a href="_e_s_l_cia402_demo_8h-example.html" class="_e_s_l_cia402_demo_8h-example.html">ESL_cia402Demo.h</a><br  />
 <a href="_e_s_l_cia402_obd_8c-example.html" class="_e_s_l_cia402_obd_8c-example.html">ESL_cia402Obd.c</a><br  />
 <a href="_e_s_l_cia402_obd_8h-example.html" class="_e_s_l_cia402_obd_8h-example.html">ESL_cia402Obd.h</a><br  />
 <a href="_ether_c_a_t__slave__ci_a402_8c-example.html" class="_ether_c_a_t__slave__ci_a402_8c-example.html">EtherCAT_Slave_CiA402.c</a><br  />
</p>
<h1><a class="anchor" id="section4226"></a>
CiA 402 Example</h1>
<p>This example configures a 3 axes motor control application. If the device or the ESI file (EtherCAT Slave Information) does not support the CiA 402 device profile, the subsequent registration calls should be disabled. The following functions are implemented in <a href="_e_s_l_cia402_demo_8c-example.html" class="_e_s_l_cia402_demo_8c-example.html">ESL_cia402Demo.c</a>.</p>
<h2><a class="anchor" id="subsection42261"></a>
EC_SLV_APP_motionControl</h2>
<p>Motion control is done in this function. The control of modes CSP, CSV or CST is shown.</p>
<h2><a class="anchor" id="subsection42262"></a>
EC_SLV_APP_cia402Application</h2>
<p>The function contains an implementation of the CiA 402 State Machine (although an external one can be registered). This state machine works alongside the CiA 402 application. The application reads the control object (<code>0x6040</code>) and writes the status object (<code>0x6041</code>). The application activates the axis and checks if there is any error pending. If an error is pending then it calls to transition actions to resolve the error and clears the error status if required.</p>
<h2><a class="anchor" id="subsection42263"></a>
EC_SLV_APP_cia402LocalError</h2>
<p>If the CiA 402 State machine changes to an error state this function is called. It is used to notify the error, not to take any action.</p>
<h1><a class="anchor" id="section4223"></a>
Basic Setup</h1>
<p>The example starts by initializing operating system (OSAL) and hardware abstraction layers (HWAL). The EtherCAT functionality itself is implemented within the <code>EC_SLV_APP_loopTask</code> that is started from the <code>main</code> application entry point, both are implemented in <code></code> <a href="_ether_c_a_t__slave__e_s_i__parser_8c-example.html" class="_ether_c_a_t__slave__e_s_i__parser_8c-example.html">EtherCAT_Slave_ESI_Parser.c</a>.</p>
<h1><a class="anchor" id="section4224"></a>
Hardware Setup</h1>
<p><code>EC_SLV_APP_loopTask</code> starts with the initialization of the GPIO driver and the configuration of the PHY and LED pins in the function <code>EC_SLV_APP_initBoardFunctions</code> in <code></code> <a href="ec_slv_e_s_i_8c-example.html" class="ec_slv_e_s_i_8c-example.html">ecSlvESI.c</a>.</p>
<p>Next PHY parameters, such as address, polarity and RX link are configured in <code>EC_SLV_APP_registerStacklessBoardFunctions</code>. The KUNBUS EtherCAT SDK supports Texas Instruments <code>TLK105</code>, <code>TLK110</code> and Microchip <code>KSZ8041NL</code> PHYs by default. Alternative PHYs may be used. In this case the SDK user has to implement and register the functions to handle the new PHYs. Use the <code>ESL_phyLibTlk110</code> sources as reference to implement your own PHY driver.</p>
<table class="image">
<caption>Program flow of the EtherCAT Slave ESI Parser Example Application</caption>
<tr>
<td><div class="image">
<img src="KBEtherCAT_ESI.png" alt=""/>
</div>
td  </td></tr>
</table>
<h1><a class="anchor" id="section4225"></a>
Initialization of Stack, PRU, and Device Identification</h1>
<p>Before entering the main stack loop, the example application itself is initialized in <code>EC_SLV_APP_applicationInit</code>. This function creates a new EtherCAT Slave device instance, registers a board status LED callback, sets vendor ID, product code and name, revision number, etc.</p>
<table class="image">
<caption>Program flow of the EtherCAT Slave ESI Parser Example Application</caption>
<tr>
<td><div class="image">
<img src="EC_SLV_ESI_applicationInit.png" alt=""/>
</div>
td  </td></tr>
</table>
<p>After the basic initialization, <code>EC_SLV_APP_applicationInit</code> continues with the setup of the CiA 402 example drives and motion control example.</p>
<h1><a class="anchor" id="section4227"></a>
CiA 402 Basics</h1>
<h2><a class="anchor" id="section42271"></a>
CiA402 State Machine</h2>
<p>CiA402 State Machine or Finite State Automation (FSA) is independent to the EtherCAT State Machine (ESM) and defines internal and external behaviour for each state. The state of the drive determines which commands are accepted and whether high power is applied. States are changed when a control-word from the host-controller is received. They can also be changed due to internal events. The current state is indicated by the status-word. The control-word and different command values (e.g. velocity) are mapped into default RxPDOs (receive process data objects). The status-word and different actual values (e.g. position) are mapped into TxPDOs.</p>
<p>For a detailed description of the state machine transition please refer to the chapter 5.1 of the ETG6010 CiA402 implementation directive.</p>
<table class="image">
<caption>CiA402 State Machine</caption>
<tr>
<td><div class="image">
<img src="cia402sm.png" alt=""/>
</div>
td  </td></tr>
</table>
<h2><a class="anchor" id="section42272"></a>
Control Word</h2>
<p>The control object 0x6040 is used to request state changes on the CiA402 state machine. The control commands are coded by bits.</p>
<table class="doxtable">
<tr>
<th>Bit </th><th>Description  </th></tr>
<tr>
<td>0 </td><td>Switch on  </td></tr>
<tr>
<td>1 </td><td>Enable voltage  </td></tr>
<tr>
<td>2 </td><td>Quick Stop  </td></tr>
<tr>
<td>3 </td><td>Enable Operation  </td></tr>
<tr>
<td>4-6 </td><td>Operation mode specific  </td></tr>
<tr>
<td>7 </td><td>Fault reset  </td></tr>
</table>
<p>These defines are available to transition between different states.</p>
<table class="doxtable">
<tr>
<th>Define </th><th>Value </th><th>Description  </th></tr>
<tr>
<td>CONTROLWORD_COMMAND_SHUTDOWN </td><td>0x0006 </td><td>Shutdown command  </td></tr>
<tr>
<td>CONTROLWORD_COMMAND_SWITCHON </td><td>0x0007 </td><td>Switch on command  </td></tr>
<tr>
<td>CONTROLWORD_COMMAND_SWITCHON_ENABLEOPERATION </td><td>0x000F </td><td>Switch on and enable command  </td></tr>
<tr>
<td>CONTROLWORD_COMMAND_DISABLEVOLTAGE </td><td>0x0000 </td><td>Disable voltage command  </td></tr>
<tr>
<td>CONTROLWORD_COMMAND_QUICKSTOP </td><td>0x0002 </td><td>Quickstop command  </td></tr>
<tr>
<td>CONTROLWORD_COMMAND_DISABLEOPERATION </td><td>0x0007 </td><td>Disable operation command  </td></tr>
<tr>
<td>CONTROLWORD_COMMAND_ENABLEOPERATION </td><td>0x000F </td><td>Enable operation command  </td></tr>
<tr>
<td>CONTROLWORD_COMMAND_FAULTRESET </td><td>0x0080 </td><td>Fault reset command  </td></tr>
</table>
<h2><a class="anchor" id="section42273"></a>
Status Word</h2>
<p>The status object 0x6041 is used to get the state of the CiA402 state machine.</p>
<table class="doxtable">
<tr>
<th>Bit </th><th>Description  </th></tr>
<tr>
<td>0 </td><td>Ready to switch on  </td></tr>
<tr>
<td>1 </td><td>Switched on  </td></tr>
<tr>
<td>2 </td><td>Operation enabled  </td></tr>
<tr>
<td>3 </td><td>Fault  </td></tr>
<tr>
<td>4 </td><td>Voltage enabled  </td></tr>
<tr>
<td>5 </td><td>Quick Stop  </td></tr>
<tr>
<td>6 </td><td>Switch on disabled  </td></tr>
</table>
<p>These defines are available to interpret the FSA states.</p>
<table class="doxtable">
<tr>
<th>Define </th><th>Value </th><th>Description  </th></tr>
<tr>
<td>STATUSWORD_STATE_NOTREADYTOSWITCHON </td><td>0x0000 </td><td>Not ready to switch on  </td></tr>
<tr>
<td>STATUSWORD_STATE_SWITCHEDONDISABLED </td><td>0x0040 </td><td>Switched on but disabled  </td></tr>
<tr>
<td>STATUSWORD_STATE_READYTOSWITCHON </td><td>0x0021 </td><td>Ready to switch on  </td></tr>
<tr>
<td>STATUSWORD_STATE_SWITCHEDON </td><td>0x0023 </td><td>Switched on  </td></tr>
<tr>
<td>STATUSWORD_STATE_OPERATIONENABLED </td><td>0x0027 </td><td>Operation enabled  </td></tr>
<tr>
<td>STATUSWORD_STATE_QUICKSTOPACTIVE </td><td>0x0007 </td><td>Quickstop active  </td></tr>
<tr>
<td>STATUSWORD_STATE_FAULTREACTIONACTIVE </td><td>0x000F </td><td>Fault reaction active  </td></tr>
<tr>
<td>STATUSWORD_STATE_FAULT </td><td>0x0008 </td><td>Fault state  </td></tr>
</table>
<h2><a class="anchor" id="section42274"></a>
Operation modes</h2>
<p>These modes are recommended to be supported by the drives:</p>
<table class="doxtable">
<tr>
<th>Operation mode </th><th>Code  </th></tr>
<tr>
<td>Profile position mode </td><td>1  </td></tr>
<tr>
<td>Velocity mode </td><td>2  </td></tr>
<tr>
<td>Profile velocity mode </td><td>3  </td></tr>
<tr>
<td>Torque profile mode </td><td>4  </td></tr>
<tr>
<td>Homing mode </td><td>6  </td></tr>
<tr>
<td>Interpolated position mode </td><td>7  </td></tr>
<tr>
<td>Cyclic synchronous position mode </td><td>8  </td></tr>
<tr>
<td>Cyclic synchronous velocity mode </td><td>9  </td></tr>
<tr>
<td>Cyclic synchronous torque mode </td><td>10  </td></tr>
<tr>
<td>Cyclic synchronous torque mode with commutation angle </td><td>11  </td></tr>
</table>
<p>The operation mode object 0x6060 is used to request an operation mode.</p>
<p>The operation mode display object 0x6061 is used to get the current operation mode.</p>
<h2><a class="anchor" id="section42275"></a>
Position control</h2>
<p>The target position object 0x607A is used to request the target position.</p>
<p>The position actual value object 0x6064 gets the drive's current position.</p>
<h2><a class="anchor" id="section42276"></a>
Velocity control</h2>
<p>The target velocity object 0x60FF is used to request the target velocity.</p>
<p>The velocity actual value object 0x606C gets the drive's current velocity.</p>
<h2><a class="anchor" id="section42277"></a>
Torque control</h2>
<p>The target torque object 0x6071 is used to request the target torque.</p>
<p>The torque actual value object 0x6077 gets the drive's current torque.</p>
<h2><a class="anchor" id="section42278"></a>
Request object summary</h2>
<p>These are the objects that must be written to the drive to command a specific operation.</p>
<table class="doxtable">
<tr>
<th>Index </th><th>Description  </th></tr>
<tr>
<td>0x6040 </td><td>Control Word  </td></tr>
<tr>
<td>0x6060 </td><td>Operation mode  </td></tr>
<tr>
<td>0x607A </td><td>Target position  </td></tr>
<tr>
<td>0x60FF </td><td>Target velocity  </td></tr>
<tr>
<td>0x6071 </td><td>Target torque  </td></tr>
</table>
<h2><a class="anchor" id="section42279"></a>
Feedback object summary</h2>
<p>These are the objects that must be read to get the current status of the drive.</p>
<table class="doxtable">
<tr>
<th>Index </th><th>Description  </th></tr>
<tr>
<td>0x6041 </td><td>Status Word  </td></tr>
<tr>
<td>0x6061 </td><td>Operation mode display  </td></tr>
<tr>
<td>0x6064 </td><td>Position actual value  </td></tr>
<tr>
<td>0x606C </td><td>Velocity actual value  </td></tr>
<tr>
<td>0x6077 </td><td>Torque actual value  </td></tr>
</table>
<h1><a class="anchor" id="section4228"></a>
Using CiA 402 Example on TwinCAT</h1>
<ul>
<li>The CiA402 demo simulates a three axes application. For each axis the objects described above are mapped as process data. Therefore, the first step is to scan the device and bring it to Operational state.</li>
</ul>
<table class="image">
<caption>CiA402 runs in OP</caption>
<tr>
<td><div class="image">
<img src="cia402demoOpstate.png" alt=""/>
</div>
td  </td></tr>
</table>
<ul>
<li>Open the <em>Drive 1</em>, the CiA402 mapped objects can be accessed there:</li>
</ul>
<table class="image">
<caption>CiA402 example process data</caption>
<tr>
<td><div class="image">
<img src="cia402procData.png" alt=""/>
</div>
td  </td></tr>
</table>
<ul>
<li>Go to the Modes of operation object and set the cyclic synchronous position mode (8):</li>
</ul>
<table class="image">
<caption>Set value dialog</caption>
<tr>
<td><div class="image">
<img src="cia402modesOfOperationSetValue.png" alt=""/>
</div>
td  </td></tr>
</table>
<table class="image">
<caption>Online view</caption>
<tr>
<td><div class="image">
<img src="cia402modesOfOperationOnlineValue.png" alt=""/>
</div>
td  </td></tr>
</table>
<ul>
<li>Go to the Modes of operation display object. It will show that the cyclic synchronous position mode has been set:</li>
</ul>
<table class="image">
<caption>Online view</caption>
<tr>
<td><div class="image">
<img src="cia402modesOfOperationDisplay.png" alt=""/>
</div>
td  </td></tr>
</table>
<ul>
<li>Go to the Target position object and set a desired position for the axis:</li>
</ul>
<table class="image">
<caption>Set value dialog</caption>
<tr>
<td><div class="image">
<img src="cia402targetPositionRequest.png" alt=""/>
</div>
td  </td></tr>
</table>
<ul>
<li>Go to the Position actual value object. As we did not enable the operation, the axis did not move:</li>
</ul>
<table class="image">
<caption>Online view</caption>
<tr>
<td><div class="image">
<img src="cia402positionActualValue1.png" alt=""/>
</div>
td  </td></tr>
</table>
<ul>
<li>Go to the Controlword object and set the switch on and enable operation commands (0x000F):</li>
</ul>
<table class="image">
<caption>Set Value Dialog</caption>
<tr>
<td><div class="image">
<img src="cia402ControlwordSetDialog.png" alt=""/>
</div>
td  </td></tr>
</table>
<table class="image">
<caption>Online view</caption>
<tr>
<td><div class="image">
<img src="cia402ControlwordOnline.png" alt=""/>
</div>
td  </td></tr>
</table>
<ul>
<li>Go to the Statusword object. It will show that drive has been switched on and the operation has been enabled:</li>
</ul>
<table class="image">
<caption>Online view</caption>
<tr>
<td><div class="image">
<img src="cia402Statusword.png" alt=""/>
</div>
td  </td></tr>
</table>
<ul>
<li>Finally, go to the Position actual value object again. As the operation has been enabled, the axis reached the target position (65536):</li>
</ul>
<table class="image">
<caption>Online view</caption>
<tr>
<td><div class="image">
<img src="cia402positionActualValue2.png" alt=""/>
</div>
td  </td></tr>
</table>
<ul>
<li>The written values as well as the values provided by the drive simulation can be seen in the object dictionary.</li>
</ul>
<table class="image">
<caption>Object Dictionary</caption>
<tr>
<td><div class="image">
<img src="cia402OBD.png" alt=""/>
</div>
td  </td></tr>
</table>
<p>The rest of the axes and other operation modes can be configured following the same steps described above. Furthermore, there are more objects used for the drive application but this example covers only the basic configuration. Please refer to the ETG6010 document for a detailed description of the CiA402 directive.</p>
<h1><a class="anchor" id="section4229"></a>
References</h1>
<ul>
<li><a href="https://www.can-cia.org/can-knowledge/canopen/cia402/">https://www.can-cia.org/can-knowledge/canopen/cia402/</a></li>
<li><a href="https://www.ethercat.org/en/downloads/downloads_733ABB98E11545EA901D80D9A4CA7F80.htm">https://www.ethercat.org/en/downloads/downloads_733ABB98E11545EA901D80D9A4CA7F80.htm</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
